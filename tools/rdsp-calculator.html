<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDSP Calculator - Enhanced with Advanced Withdrawal Planning</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #FFFFFF;
            min-height: 100vh;
            padding: 20px;
            color: #111827;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.dark-mode {
            background: #121212;
            color: #E5E7EB;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #6B7280;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 12px;
            transition: color 0.3s;
        }
        
        body.dark-mode .back-link {
            color: #9CA3AF;
        }
        
        .back-link:hover {
            color: #111827;
        }
        
        body.dark-mode .back-link:hover {
            color: #E5E7EB;
        }
        
        .max-w-7xl {
            max-width: 1280px;
            margin: 0 auto;
        }
        
        .bg-white {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        body.dark-mode .bg-white {
            background: #1F2937;
            border-color: #374151;
        }
        
        .rounded-lg {
            border-radius: 12px;
        }
        
        .shadow-xl {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .p-6 {
            padding: 24px;
        }
        
        .mb-6 {
            margin-bottom: 24px;
        }
        
        .mb-4 {
            margin-bottom: 16px;
        }
        
        .mb-3 {
            margin-bottom: 12px;
        }
        
        .mb-2 {
            margin-bottom: 8px;
        }
        
        .mb-1 {
            margin-bottom: 4px;
        }
        
        .mt-1 {
            margin-top: 4px;
        }
        
        .mt-2 {
            margin-top: 8px;
        }
        
        .mt-3 {
            margin-top: 12px;
        }
        
        .mt-4 {
            margin-top: 16px;
        }
        
        .flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .items-center {
            align-items: center;
        }
        
        .items-start {
            align-items: flex-start;
        }
        
        .gap-2 {
            gap: 8px;
        }
        
        .gap-3 {
            gap: 12px;
        }
        
        .gap-4 {
            gap: 16px;
        }
        
        .grid {
            display: grid;
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .grid-cols-6 {
            grid-template-columns: repeat(6, 1fr);
        }
        
        .md\\:grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .md\\:grid-cols-6 {
            grid-template-columns: repeat(6, 1fr);
        }
        
        @media (min-width: 768px) {
            .md\\:grid-cols-2 {
                grid-template-columns: repeat(2, 1fr);
            }
            .md\\:grid-cols-6 {
                grid-template-columns: repeat(6, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            .grid-cols-6 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }
        
        h3 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 16px;
        }
        
        .text-sm {
            font-size: 14px;
        }
        
        .text-xs {
            font-size: 12px;
        }
        
        .text-lg {
            font-size: 18px;
        }
        
        .text-3xl {
            font-size: 30px;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .text-gray-600 {
            color: #6B7280;
        }
        
        .text-gray-700 {
            color: #374151;
        }
        
        .text-gray-800 {
            color: #111827;
        }
        
        .text-indigo-900 {
            color: #111827;
        }
        
        .text-white {
            color: white;
        }
        
        .text-green-600 {
            color: #16a34a;
        }
        
        .text-green-700 {
            color: #15803d;
        }
        
        .text-red-500 {
            color: #ef4444;
        }
        
        .text-red-600 {
            color: #dc2626;
        }
        
        .text-orange-600 {
            color: #ea580c;
        }
        
        .text-orange-700 {
            color: #c2410c;
        }
        
        .text-orange-800 {
            color: #9a3412;
        }
        
        .text-blue-600 {
            color: #2563eb;
        }
        
        .text-blue-700 {
            color: #1d4ed8;
        }
        
        .text-blue-800 {
            color: #1e40af;
        }
        
        .text-blue-900 {
            color: #1e3a8a;
        }
        
        .text-yellow-600 {
            color: #ca8a04;
        }
        
        .text-yellow-700 {
            color: #a16207;
        }
        
        .text-yellow-800 {
            color: #854d0e;
        }
        
        .text-purple-600 {
            color: #9333ea;
        }
        
        .text-pink-600 {
            color: #db2777;
        }
        
        .bg-gradient-to-br {
            background: linear-gradient(to bottom right, var(--tw-gradient-stops));
        }
        
        .from-green-500 {
            --tw-gradient-from: #22c55e;
        }
        
        .to-green-600 {
            --tw-gradient-to: #16a34a;
        }
        
        .from-blue-500 {
            --tw-gradient-from: #3b82f6;
        }
        
        .to-blue-600 {
            --tw-gradient-to: #2563eb;
        }
        
        .from-purple-500 {
            --tw-gradient-from: #a855f7;
        }
        
        .to-purple-600 {
            --tw-gradient-to: #9333ea;
        }
        
        .from-pink-500 {
            --tw-gradient-from: #ec4899;
        }
        
        .to-pink-600 {
            --tw-gradient-to: #db2777;
        }
        
        .from-indigo-500 {
            --tw-gradient-from: #6366f1;
        }
        
        .to-indigo-600 {
            --tw-gradient-to: #4f46e5;
        }
        
        .from-red-500 {
            --tw-gradient-from: #ef4444;
        }
        
        .to-red-600 {
            --tw-gradient-to: #dc2626;
        }
        
        .bg-amber-50 {
            background: #F9FAFB;
        }
        
        .bg-blue-50 {
            background: #F9FAFB;
        }
        
        .bg-green-50 {
            background: #F9FAFB;
        }
        
        .bg-yellow-50 {
            background: #F9FAFB;
        }
        
        .bg-indigo-50 {
            background: #F9FAFB;
        }
        
        .bg-orange-50 {
            background: #F9FAFB;
        }
        
        .bg-gray-50 {
            background: #F9FAFB;
        }
        
        .bg-gray-600 {
            background: #4b5563;
        }
        
        .bg-gray-700 {
            background: #374151;
        }
        
        .bg-indigo-600 {
            background: #4f46e5;
        }
        
        .bg-indigo-700 {
            background: #4338ca;
        }
        
        .bg-green-600 {
            background: #16a34a;
        }
        
        .bg-green-700 {
            background: #15803d;
        }
        
        .bg-red-500 {
            background: #ef4444;
        }
        
        .bg-red-600 {
            background: #dc2626;
        }
        
        .border {
            border-width: 1px;
        }
        
        .border-gray-200 {
            border-color: #e5e7eb;
        }
        
        .border-gray-300 {
            border-color: #d1d5db;
        }
        
        .border-amber-200 {
            border-color: #E5E7EB;
        }
        
        .border-blue-200 {
            border-color: #E5E7EB;
        }
        
        .border-green-200 {
            border-color: #E5E7EB;
        }
        
        .border-yellow-200 {
            border-color: #E5E7EB;
        }
        
        .border-indigo-200 {
            border-color: #E5E7EB;
        }
        
        .border-indigo-300 {
            border-color: #D1D5DB;
        }
        
        .border-orange-200 {
            border-color: #E5E7EB;
        }
        
        .rounded-md {
            border-radius: 6px;
        }
        
        .rounded-lg {
            border-radius: 12px;
        }
        
        .p-3 {
            padding: 12px;
        }
        
        .p-4 {
            padding: 16px;
        }
        
        .px-2 {
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .px-3 {
            padding-left: 12px;
            padding-right: 12px;
        }
        
        .px-4 {
            padding-left: 16px;
            padding-right: 16px;
        }
        
        .py-1 {
            padding-top: 4px;
            padding-bottom: 4px;
        }
        
        .py-2 {
            padding-top: 8px;
            padding-bottom: 8px;
        }
        
        .w-full {
            width: 100%;
        }
        
        .w-5 {
            width: 20px;
        }
        
        .h-4 {
            height: 16px;
        }
        
        .h-5 {
            height: 20px;
        }
        
        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 15px;
            background: #FFFFFF;
            color: #111827;
            transition: border-color 0.2s, background-color 0.3s, color 0.3s;
        }
        
        body.dark-mode input[type="number"],
        body.dark-mode input[type="text"] {
            background: #1F2937;
            border-color: #374151;
            color: #E5E7EB;
        }
        
        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #6B7280;
            box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
        }
        
        body.dark-mode input[type="number"]:focus,
        body.dark-mode input[type="text"]:focus {
            border-color: #9CA3AF;
            box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.2);
        }
        
        input[type="checkbox"],
        input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .space-y-1 > * + * {
            margin-top: 4px;
        }
        
        .space-y-2 > * + * {
            margin-top: 8px;
        }
        
        .space-y-3 > * + * {
            margin-top: 12px;
        }
        
        .space-y-4 > * + * {
            margin-top: 16px;
        }
        
        .space-x-2 > * + * {
            margin-left: 8px;
        }
        
        .opacity-90 {
            opacity: 0.9;
        }
        
        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .max-h-64 {
            max-height: 256px;
        }
        
        .max-h-96 {
            max-height: 384px;
        }
        
        .overflow-y-auto {
            overflow-y: auto;
        }
        
        .border-b {
            border-bottom-width: 1px;
        }
        
        .pb-2 {
            padding-bottom: 8px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 24px;
        }
        
        .chart-container-small {
            position: relative;
            height: 300px;
            margin-bottom: 24px;
        }
        
        .summary-card {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .summary-card:hover {
            border-color: #D1D5DB;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .summary-card .label {
            font-size: 12px;
            color: #6B7280;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-card .value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        /* Annual Breakdown hover panel (avoids covering the chart) */
        .breakdown-layout {
            display: flex;
            gap: 12px;
            height: 100%;
        }

        .breakdown-canvas {
            flex: 1 1 auto;
            min-width: 0;
            height: 100%;
        }

        .breakdown-hover {
            width: 280px;
            flex: 0 0 280px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px;
            overflow: auto;
            font-size: 12px;
            color: #374151;
        }

        .breakdown-hover .title {
            font-weight: 700;
            color: #111827;
            margin-bottom: 6px;
        }

        .breakdown-hover .muted {
            color: #6b7280;
        }

        .breakdown-hover .row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 4px 0;
            border-bottom: 1px dashed #e5e7eb;
        }

        .breakdown-hover .row:last-child {
            border-bottom: none;
        }

        .breakdown-hover .k {
            color: #6b7280;
        }

        .breakdown-hover .v {
            font-weight: 600;
            color: #111827;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .breakdown-layout {
                flex-direction: column;
            }
            .breakdown-hover {
                width: 100%;
                flex: 0 0 auto;
            }
        }
        
        /* Range Slider Styles */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
            height: 20px;
            margin: 10px 0;
        }
        
        input[type="range"] {
            background: transparent;
        }
        
        input[type="range"]::-webkit-slider-track {
            background: #9CA3AF;
            height: 6px;
            border-radius: 3px;
            border: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #111827;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -7px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"]::-moz-range-track {
            background: #9CA3AF;
            height: 6px;
            border-radius: 3px;
            border: none;
        }
        
        input[type="range"]::-moz-range-thumb {
            background: #111827;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"]:focus {
            outline: none;
        }
        
        input[type="range"]:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.2), 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"]:focus::-moz-range-thumb {
            box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.2), 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"]:hover::-webkit-slider-thumb {
            background: #374151;
        }
        
        input[type="range"]:hover::-moz-range-thumb {
            background: #374151;
        }
        
        body.dark-mode input[type="range"]::-webkit-slider-track {
            background: #4B5563;
        }
        
        body.dark-mode input[type="range"]::-moz-range-track {
            background: #4B5563;
        }
        
        body.dark-mode input[type="range"]::-webkit-slider-thumb {
            background: #9CA3AF;
            border-color: #1F2937;
        }
        
        body.dark-mode input[type="range"]::-moz-range-thumb {
            background: #9CA3AF;
            border-color: #1F2937;
        }
        
        /* Slider container background for visibility */
        .slider-wrapper {
            background: #FFFFFF;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #E5E7EB;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        body.dark-mode .slider-wrapper {
            background: #1F2937;
            border-color: #374151;
        }
        
        /* Dark Mode Styles - Matching Tax Suite Color Scheme */
        body.dark-mode {
            background: #111827;
            color: #f8fafc;
        }
        
        body.dark-mode .max-w-7xl {
            background: transparent;
        }
        
        body.dark-mode .bg-white {
            background: #1f2937;
            border-color: #374151;
        }
        
        body.dark-mode .back-link {
            color: #9ca3af;
        }
        
        body.dark-mode .back-link:hover {
            color: #f8fafc;
        }
        
        body.dark-mode .text-gray-600,
        body.dark-mode .text-gray-700 {
            color: #d1d5db;
        }
        
        body.dark-mode .text-gray-800 {
            color: #f3f4f6;
        }
        
        body.dark-mode .text-indigo-900 {
            color: #c7d2fe;
        }
        
        body.dark-mode input[type="number"],
        body.dark-mode input[type="text"],
        body.dark-mode select {
            background: #374151;
            border-color: #4b5563;
            color: #f8fafc;
        }
        
        body.dark-mode input[type="number"]:focus,
        body.dark-mode input[type="text"]:focus,
        body.dark-mode select:focus {
            border-color: #9CA3AF;
            background: #4b5563;
        }
        
        body.dark-mode .bg-amber-50 {
            background: #78350f;
            border-color: #92400e;
        }
        
        body.dark-mode .bg-blue-50 {
            background: #1e3a8a;
            border-color: #1e40af;
        }
        
        body.dark-mode .bg-green-50 {
            background: #14532d;
            border-color: #166534;
        }
        
        body.dark-mode .bg-yellow-50 {
            background: #713f12;
            border-color: #854d0e;
        }
        
        body.dark-mode .bg-indigo-50 {
            background: #312e81;
            border-color: #3730a3;
        }
        
        body.dark-mode .bg-orange-50 {
            background: #7c2d12;
            border-color: #9a3412;
        }
        
        body.dark-mode .bg-gray-50 {
            background: #374151;
            border-color: #4b5563;
        }
        
        body.dark-mode .border-gray-200,
        body.dark-mode .border-gray-300 {
            border-color: #4b5563;
        }
        
        body.dark-mode .border-amber-200 {
            border-color: #92400e;
        }
        
        body.dark-mode .border-blue-200 {
            border-color: #1e40af;
        }
        
        body.dark-mode .border-green-200 {
            border-color: #166534;
        }
        
        body.dark-mode .border-yellow-200 {
            border-color: #854d0e;
        }
        
        body.dark-mode .border-indigo-200,
        body.dark-mode .border-indigo-300 {
            border-color: #3730a3;
        }
        
        body.dark-mode .border-orange-200 {
            border-color: #9a3412;
        }
        
        body.dark-mode input[type="range"]::-webkit-slider-track {
            background: #4b5563;
        }
        
        body.dark-mode input[type="range"]::-moz-range-track {
            background: #4b5563;
        }
        
        body.dark-mode .chart-container,
        body.dark-mode .chart-container-small {
            background: #1f2937;
            border-radius: 8px;
            padding: 10px;
        }
        
        body.dark-mode .text-blue-900 {
            color: #bfdbfe;
        }
        
        body.dark-mode h1,
        body.dark-mode h3,
        body.dark-mode h4 {
            color: #f3f4f6;
        }
        
        body.dark-mode .summary-card {
            background: #1F2937;
            border-color: #374151;
        }
        
        body.dark-mode .summary-card .label {
            color: #9CA3AF;
        }
        
        body.dark-mode .summary-card .value {
            color: #E5E7EB;
        }

        body.dark-mode .breakdown-hover {
            background: #1f2937;
            border-color: #374151;
            color: #d1d5db;
        }

        body.dark-mode .breakdown-hover .title {
            color: #f3f4f6;
        }

        body.dark-mode .breakdown-hover .v {
            color: #f3f4f6;
        }

        body.dark-mode .breakdown-hover .row {
            border-bottom-color: #374151;
        }
        
        body.dark-mode .text-gray-500 {
            color: #9ca3af;
        }
        
        /* Clickable amounts styling */
        .clickable-amount {
            transition: all 0.2s;
        }
        
        .clickable-amount:hover {
            text-decoration-thickness: 2px;
        }
        
        body.dark-mode .clickable-amount {
            color: #818cf8 !important;
        }
        
        body.dark-mode .clickable-amount:hover {
            color: #a5b4fc !important;
        }
        
        /* Preview Modal */
        #previewModal {
            display: flex;
        }
        
        #previewModal.hidden {
            display: none;
        }
        
        body.dark-mode #previewModal .bg-white {
            background: #1f2937;
            color: #f8fafc;
        }
        
        body.dark-mode #previewModal h3 {
            color: #f3f4f6;
        }
        
        body.dark-mode #previewModal .text-gray-700 {
            color: #d1d5db;
        }
        
        body.dark-mode #previewModal button {
            color: #f8fafc;
        }
        
        body.dark-mode #previewModal .bg-green-50 {
            background: #14532d;
            border-color: #166534;
        }
        
        body.dark-mode #previewModal .text-green-700,
        body.dark-mode #previewModal .text-green-800 {
            color: #86efac;
        }
        
        body.dark-mode #previewModal .bg-blue-50 {
            background: #1e3a8a;
            border-color: #1e40af;
        }
        
        body.dark-mode #previewModal .text-blue-700,
        body.dark-mode #previewModal .text-blue-800 {
            color: #93c5fd;
        }
        
        body.dark-mode #previewModal .bg-yellow-50 {
            background: #713f12;
            border-color: #854d0e;
        }
        
        body.dark-mode #previewModal .text-yellow-700,
        body.dark-mode #previewModal .text-yellow-800 {
            color: #fde047;
        }
        
        body.dark-mode #previewModal .bg-gray-50 {
            background: #374151;
            border-color: #4b5563;
        }
        
        body.dark-mode #previewModal .border-gray-200 {
            border-color: #4b5563;
        }
        
        /* Chart Age Range improvements */
        body.dark-mode #chartAgeMinInput,
        body.dark-mode #chartAgeMaxInput {
            background: #374151;
            border-color: #4b5563;
            color: #f8fafc;
        }
        
        body.dark-mode #chartAgeMinInput:focus,
        body.dark-mode #chartAgeMaxInput:focus {
            border-color: #9CA3AF;
            background: #4b5563;
        }
        
        body.dark-mode button[onclick*="setChartRange"] {
            background: #1f2937;
            border-color: #374151;
            color: #f8fafc;
        }
        
        body.dark-mode button[onclick*="setChartRange"]:hover {
            background: #374151;
            border-color: #4b5563;
        }
        
        body.dark-mode button[onclick*="setChartRange('all')"] {
            background: #4f46e5;
            border-color: #6366f1;
        }
        
        body.dark-mode button[onclick*="setChartRange('all')"]:hover {
            background: #6366f1;
        }
        
        body.dark-mode .bg-white.border.border-gray-300 {
            background: #1f2937;
            border-color: #374151;
        }
        
        body.dark-mode .bg-white.border.border-gray-300 .text-gray-800 {
            color: #f3f4f6;
        }
        
        body.dark-mode .bg-white.border.border-gray-300 .text-gray-600 {
            color: #9ca3af;
        }
        
        /* Visual Range Slider Styles */
        #rangeSliderContainer {
            -webkit-user-select: none;
            user-select: none;
        }

        /* Standalone visual range slider (do not rely on Tailwind utility classes) */
        #rangeSliderContainer {
            position: relative;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 16px;
        }

        #rangeTrackArea {
            position: relative;
            height: 56px;
            margin-top: 6px;
        }

        #rangeTrack {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 8px;
            background: #e5e7eb;
            border-radius: 999px;
        }

        #rangeHighlight {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: 8px;
            background: #6366f1;
            border-radius: 999px;
        }

        .range-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 44px;
            background: #ffffff;
            border: 2px solid #9ca3af;
            border-radius: 10px;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
            cursor: grab;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            z-index: 5;
        }

        .range-handle:hover {
            border-color: #6366f1;
            box-shadow: 0 10px 18px rgba(0, 0, 0, 0.16);
        }

        .range-handle:active {
            cursor: grabbing;
        }

        .range-handle::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 8px;
            transform: translateX(-50%);
            width: 2px;
            height: 28px;
            background: #4b5563;
            border-radius: 999px;
        }

        #rangeLabels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        #rangePresets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        #rangePresets button {
            padding: 6px 10px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            color: #374151;
            border-radius: 8px;
            font-size: 12px;
        }

        #rangePresets button:hover {
            background: #f9fafb;
        }

        #rangePresets button.preset-primary {
            background: #4f46e5;
            border-color: #4f46e5;
            color: #ffffff;
            font-weight: 600;
        }

        #rangePresets button.preset-primary:hover {
            background: #4338ca;
            border-color: #4338ca;
        }
        
        .cursor-grab {
            cursor: grab;
        }
        
        .cursor-grab:active,
        .active.cursor-grabbing {
            cursor: grabbing;
        }
        
        #rangeTrack {
            transition: background-color 0.3s;
        }
        
        body.dark-mode #rangeSliderContainer {
            background: #1f2937;
            border-color: #374151;
        }
        
        body.dark-mode #rangeTrack {
            background: #4b5563;
        }
        
        body.dark-mode #rangeHighlight {
            background: #6366f1;
        }
        
        body.dark-mode #leftHandle,
        body.dark-mode #rightHandle {
            background: #1f2937;
            border-color: #6b7280;
        }
        
        body.dark-mode #leftHandle:hover,
        body.dark-mode #rightHandle:hover {
            border-color: #818cf8;
        }
        
        body.dark-mode #leftHandle .bg-gray-600,
        body.dark-mode #rightHandle .bg-gray-600 {
            background: #9ca3af;
        }
        
        body.dark-mode #ageRangeDisplay {
            color: #f3f4f6;
        }
        
        body.dark-mode #minAgeLabel,
        body.dark-mode #maxAgeLabel {
            color: #9ca3af;
        }
        
        body.dark-mode #rangeSliderContainer button {
            background: #1f2937;
            border-color: #4b5563;
            color: #d1d5db;
        }
        
        body.dark-mode #rangeSliderContainer button:hover {
            background: #374151;
            border-color: #6b7280;
        }
        
        body.dark-mode #rangeSliderContainer button.bg-indigo-600 {
            background: #6366f1;
            border-color: #6366f1;
            color: white;
        }
        
        body.dark-mode #rangeSliderContainer button.bg-indigo-600:hover {
            background: #818cf8;
        }
        
        body.dark-mode #rangeSliderContainer .border-gray-200 {
            border-color: #4b5563;
        }
        
        /* Dark Mode Toggle Button */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #1f2937;
            border: 2px solid #374151;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #f8fafc;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .dark-mode-toggle:hover {
            background: #374151;
            border-color: #4b5563;
        }
        
        body.dark-mode .dark-mode-toggle {
            background: #f8fafc;
            border-color: #e5e7eb;
            color: #111827;
        }
        
        body.dark-mode .dark-mode-toggle:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }
        
        @media (max-width: 768px) {
            .dark-mode-toggle {
                top: 10px;
                right: 10px;
                padding: 6px 10px;
                font-size: 12px;
            }
        }
        
        /* Table styles */
        body.dark-mode table {
            border-color: #4b5563;
        }
        
        body.dark-mode table th {
            background: #374151;
            color: #f3f4f6;
            border-color: #4b5563;
        }
        
        body.dark-mode table td {
            color: #d1d5db;
            border-color: #4b5563;
        }
        
        body.dark-mode table tr:hover {
            background: #374151;
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" id="darkModeToggle">
        <span class="material-icons" id="darkModeIcon">dark_mode</span>
        <span id="darkModeText">Dark Mode</span>
    </button>
    
    <div class="max-w-7xl">
        <a href="../index.html" class="back-link">
            <span class="material-icons" style="font-size:18px;">arrow_back</span>
            Back to Portfolio
        </a>
        
        <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1>Enhanced RDSP Calculator</h1>
                    <p class="text-sm text-gray-600">Based on 2024/2025 CRA Rules with Advanced Withdrawal Planning</p>
                </div>
                <button onclick="resetCalculator()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Reset
                </button>
            </div>

            <!-- Input Section -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- Personal Information -->
                <div class="space-y-4">
                    <h3 class="border-b pb-2">Personal Information</h3>
                    
                    <div>
                        <label for="currentAge" class="block text-sm font-medium text-gray-700 mb-1">Current Age</label>
                        <input type="number" id="currentAge" aria-label="Current Age" value="30" min="0" max="100" oninput="updateCalculations()">
                    </div>

                    <div>
                        <label for="dtcStartAge" class="block text-sm font-medium text-gray-700 mb-1">Age When DTC Approved</label>
                        <input type="number" id="dtcStartAge" aria-label="Age When DTC Approved" value="17" min="0" max="100" oninput="updateCalculations()">
                    </div>

                    <div>
                        <label for="familyIncome" class="block text-sm font-medium text-gray-700 mb-1">Current Family Net Income (2025)</label>
                        <input type="number" id="familyIncome" aria-label="Current Family Net Income (2025)" value="100000" min="0" oninput="updateCalculations()">
                        <div class="text-xs text-gray-500 mt-1" id="incomeEligibility"></div>
                    </div>

                    <div>
                        <label for="endAge" class="block text-sm font-medium text-gray-700 mb-1">End Projection at Age</label>
                        <input type="number" id="endAge" aria-label="End Projection at Age" value="90" min="0" max="120" oninput="updateCalculations()">
                        <div class="text-xs text-gray-500 mt-1">Set the final age for projections and graph</div>
                    </div>
                </div>

                <!-- Contribution & Investment Details -->
                <div class="space-y-4">
                    <h3 class="border-b pb-2">Contributions & Investment</h3>
                    
                    <div>
                        <label for="annualContribution" class="block text-sm font-medium text-gray-700 mb-1">Annual Contribution (until age 59)</label>
                        <input type="number" id="annualContribution" aria-label="Annual Contribution (until age 59)" value="1500" min="0" oninput="updateCalculations()">
                        <div class="text-xs text-gray-500 mt-1">Lifetime max: $200,000. Optimal: $1,500/yr (low income) or $1,000/yr (high income)</div>
                    </div>
                    
                    <div id="stopContribsContainer" style="display: none;">
                        <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <input type="checkbox" id="stopContribsAtWithdrawal" checked onchange="updateCalculations()">
                            <label class="text-sm text-gray-700">
                                Stop contributions when early retirement/withdrawals begin
                                <div class="text-xs text-gray-600 mt-0.5">(Useful for early retirement scenarios at 45-50)</div>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label for="returnRate" class="block text-sm font-medium text-gray-700 mb-1">Annual Return Rate (%)</label>
                        <input type="number" id="returnRate" aria-label="Annual Return Rate (%)" value="5" min="0" max="20" step="0.1" oninput="updateCalculations()">
                    </div>

                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="payDividends" aria-label="Pay Out Dividends" onchange="updateCalculations()">
                        <label for="payDividends" class="text-sm font-medium text-gray-700">Pay Out Dividends</label>
                    </div>

                    <div id="dividendRateContainer" style="display: none;">
                        <label for="dividendRate" class="block text-sm font-medium text-gray-700 mb-1">Dividend Rate (%)</label>
                        <input type="number" id="dividendRate" aria-label="Dividend Rate (%)" value="2" min="0" max="20" step="0.1" oninput="updateCalculations()">
                    </div>
                </div>
            </div>

            <!-- Carry-Forward Section -->
            <div class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="font-semibold text-lg text-gray-800 mb-2">Carry-Forward Eligibility (Past 10 Years)</h3>
                <p class="text-sm text-gray-600 mb-4" id="carryForwardSummary"></p>
                <div class="space-y-2 max-h-96 overflow-y-auto" id="carryForwardYears"></div>
            </div>
            
            <!-- Preview Modal -->
            <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" style="display: none;">
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800" id="previewModalTitle"></h3>
                        <button onclick="closePreviewModal()" class="text-gray-500 hover:text-gray-700">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div id="previewModalContent" class="text-sm text-gray-700 space-y-3"></div>
                    <button onclick="closePreviewModal()" class="mt-4 w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Close
                    </button>
                </div>
            </div>

            <!-- Withdrawal Planning -->
            <div class="mb-6">
                <h3 class="font-semibold text-lg text-gray-800 border-b pb-2 mb-4">Withdrawals</h3>
                
                <!-- Withdrawal Type Selection -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Withdrawal Mode</label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="radio" name="withdrawalType" id="ldap" value="ldap" checked onchange="updateCalculations()">
                            <label for="ldap" class="ml-2 text-sm text-gray-700">
                                <strong>LDAP (Lifetime Disability Assistance Payments)</strong> — Automatic pension-style withdrawals (60+)
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="withdrawalType" id="manual" value="manual" onchange="updateCalculations()">
                            <label for="manual" class="ml-2 text-sm text-gray-700">
                                <strong>Manual Withdrawals (DAPs)</strong> — Pick exact ages/amounts (10-year rule applies before 60)
                            </label>
                        </div>
                    </div>
                    
                    <div id="ldapAgeContainer" class="mt-3">
                        <label for="ldapAge" class="block text-sm font-medium text-gray-700 mb-1">Start LDAP at age</label>
                        <input type="number" id="ldapAge" aria-label="Start LDAP at age" value="60" min="60" max="120" oninput="updateCalculations()">
                        <div class="text-xs text-gray-600 mt-1">LDAPs automatically calculate optimal withdrawals. Before 80: balance ÷ (83 - age). After 80: balance ÷ 3</div>
                    </div>
                </div>

                <!-- Strategy Comparison Toggle (LDAP only) -->
                <div id="comparisonToggleContainer" class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="showComparison" aria-label="Compare LDAP vs Optimal withdrawals" onchange="updateCalculations()">
                            <label for="showComparison" class="text-sm font-semibold text-gray-800">Compare LDAP vs “Optimal” withdrawals</label>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600">Shows a side-by-side view starting at the age you choose (LDAP requires 60+).</p>
                    
                    <div id="comparisonAgeContainer" style="display: none;" class="mt-3 bg-white rounded-lg p-3 border border-gray-300">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Comparison starts at age</label>
                        <input type="number" id="comparisonStartAge" value="60" min="60" max="120" oninput="updateCalculations()">
                        <div class="text-xs text-gray-600 mt-1">This does not change your plan — it’s just a comparison view.</div>
                    </div>
                </div>
                
                <!-- Manual Withdrawal Section -->
                <div id="manualWithdrawalSection" style="display: none;">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-3">
                        <div class="text-xs font-semibold text-gray-800 mb-1">⚠️ 10-Year Repayment Rule</div>
                        <div class="text-xs text-gray-700">Withdrawals before age 60 require repaying $3 in grants/bonds for every $1 withdrawn (from last 10 years)</div>
                    </div>

                    <!-- Quick plan: auto-generate withdrawals -->
                    <div class="bg-white rounded-lg p-3 border border-gray-300 mb-3">
                        <div class="text-sm font-semibold text-gray-800 mb-2">Quick plan</div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Start withdrawals at age</label>
                                <input type="number" id="manualStartAge" value="60" min="0" max="120" oninput="syncManualQuickPlan()">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">End at age</label>
                                <input type="number" id="manualEndAge" value="90" min="0" max="120" oninput="syncManualQuickPlan()">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs text-gray-600 mb-1">Annual withdrawal amount</label>
                                <input type="number" id="manualAnnualWithdrawal" value="5000" min="0" oninput="syncManualQuickPlan()">
                                <div class="text-xs text-gray-500 mt-1">This will create one withdrawal entry per year. You can edit/remove any entry afterwards.</div>
                            </div>
                        </div>
                        <button onclick="generateWithdrawalSchedule()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 mt-3">
                            Auto-generate yearly withdrawals
                        </button>
                    </div>
                    
                    <div id="withdrawalsList"></div>
                    
                    <button onclick="addWithdrawal()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 mt-3">
                        + Add Manual Withdrawal
                    </button>
                </div>
            </div>

            <!-- Visual Chart Age Range Slider -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold text-lg text-gray-800">Chart Age Range</h3>
                    <div class="text-sm font-semibold text-gray-700" id="ageRangeDisplay">30 - 90</div>
                </div>

                <div id="rangeSliderContainer">
                    <div id="rangeTrackArea">
                        <div id="rangeTrack"></div>
                        <div id="rangeHighlight" style="left: 0%; width: 100%;"></div>

                        <div
                            id="leftHandle"
                            class="range-handle"
                            style="left: 0%;"
                            onmousedown="startDrag('left', event)"
                            ontouchstart="startDrag('left', event)"
                        ></div>

                        <div
                            id="rightHandle"
                            class="range-handle"
                            style="left: 100%;"
                            onmousedown="startDrag('right', event)"
                            ontouchstart="startDrag('right', event)"
                        ></div>
                    </div>

                    <div id="rangeLabels">
                        <span id="minAgeLabel">30</span>
                        <span id="maxAgeLabel">90</span>
                    </div>

                    <div id="rangePresets">
                        <button onclick="setChartRange('early')">Early (30-50)</button>
                        <button onclick="setChartRange('mid')">Mid (50-70)</button>
                        <button onclick="setChartRange('late')">Late (70-90)</button>
                        <button onclick="setChartRange('all')" class="preset-primary">All Years</button>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="mb-6">
                <h3 class="font-semibold text-lg text-gray-800 mb-4">Account Value Over Time</h3>
                <div class="chart-container">
                    <canvas id="balanceChart"></canvas>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Annual Breakdown</h3>
                    </div>
                </div>
                <div id="breakdownChartContainer" class="chart-container-small">
                    <div class="breakdown-layout">
                        <div class="breakdown-canvas">
                            <canvas id="breakdownChart"></canvas>
                        </div>
                        <div id="breakdownHoverPanel" class="breakdown-hover">
                            <div class="title">Hover details</div>
                            <div class="muted">Move your mouse over the chart to see the full breakdown for that age.</div>
                        </div>
                    </div>
                </div>
                <div id="breakdownTableContainer">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 text-sm" id="breakdownTable">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold text-gray-800">Age</th>
                                    <th class="border border-gray-300 px-3 py-2 text-right font-semibold text-gray-800">Balance</th>
                                    <th class="border border-gray-300 px-3 py-2 text-right font-semibold text-gray-800">Contributions</th>
                                    <th class="border border-gray-300 px-3 py-2 text-right font-semibold text-gray-800">Grants</th>
                                    <th class="border border-gray-300 px-3 py-2 text-right font-semibold text-gray-800">Bonds</th>
                                    <th class="border border-gray-300 px-3 py-2 text-right font-semibold text-gray-800">Growth</th>
                                    <th class="border border-gray-300 px-3 py-2 text-right font-semibold text-gray-800">Withdrawals</th>
                                    <th class="border border-gray-300 px-3 py-2 text-right font-semibold text-gray-800">10Y Penalty</th>
                                </tr>
                            </thead>
                            <tbody id="breakdownTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mb-6" id="withdrawalChartContainer" style="display: none;">
                <h3 class="font-semibold text-lg text-gray-800 mb-4">Withdrawal Breakdown</h3>
                <div class="chart-container-small">
                    <canvas id="withdrawalChart"></canvas>
                </div>
            </div>

            <!-- Info Box -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm text-gray-700">
                <h4 class="font-semibold mb-2 text-gray-800">Enhanced Features Based on CRA Rules:</h4>
                <ul class="space-y-1 text-xs text-gray-600">
                    <li>• <strong>LDAP (Lifetime Disability Assistance Payments):</strong> Automatic pension-style withdrawals starting at 60</li>
                    <li>• <strong>10-Year Repayment Rule:</strong> Early withdrawals (before 60) lose $3 of grants/bonds for every $1 withdrawn</li>
                    <li>• <strong>Taxable Withdrawals:</strong> Everything except personal contributions is taxed upon withdrawal</li>
                    <li>• <strong>LDAP Formula:</strong> Before 80: balance ÷ (83 - age), After 80: balance ÷ 3</li>
                    <li>• <strong>Carry-forward:</strong> Catch up on past 10 DTC-approved years (max $10,500 grants + $11,000 bonds per year)</li>
                </ul>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mt-6" id="summaryCards"></div>
        </div>
    </div>

    <script>
        // State management
        let state = {
            currentAge: 30,
            familyIncome: 100000,
            annualContribution: 1500,
            returnRate: 5,
            payDividends: false,
            dividendRate: 2,
            withdrawals: [],
            dtcStartAge: 17,
            endAge: 90,
            showOptimalWithdrawal: false,
            ldapStartAge: 60,
            comparisonStartAge: 60,
            manualStartAge: 60,
            manualEndAge: 90,
            manualAnnualWithdrawal: 5000,
            withdrawalType: 'ldap',
            stopContribsAtWithdrawal: true,
            showComparison: false,
            carryForwardYears: [],
            chartAgeRange: [30, 90]
        };
        
        let allProjectionData = []; // Store all data for filtering
        let noGrowthProjectionData = []; // Same scenario, but with 0% return (used for hover when Growth is hidden)

        // Dark Mode Toggle
        function toggleDarkMode() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            
            // Update icon and text
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            
            if (isDark) {
                icon.textContent = 'light_mode';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = 'dark_mode';
                text.textContent = 'Dark Mode';
            }
            
            // Save preference
            localStorage.setItem('rdspDarkMode', isDark);
            
            // Update charts for dark mode
            if (allProjectionData.length > 0) {
                updateCharts();
            }
            
            // Update table if visible
            if (breakdownViewMode === 'table') {
                updateBreakdownTable();
            }
        }
        
        // Initialize dark mode from localStorage (default to light mode)
        function initDarkMode() {
            const saved = localStorage.getItem('rdspDarkMode');
            
            // Only apply dark mode if explicitly saved as 'true', default to light
            if (saved === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = 'light_mode';
                document.getElementById('darkModeText').textContent = 'Light Mode';
            } else {
                // Default to light mode
                document.body.classList.remove('dark-mode');
                document.getElementById('darkModeIcon').textContent = 'dark_mode';
                document.getElementById('darkModeText').textContent = 'Dark Mode';
            }
        }
        
        // Initialize on page load
        initDarkMode();

        // Initialize carry-forward years (removed personal details)
        function initializeCarryForwardYears() {
            const currentYear = new Date().getFullYear();
            const years = [];
            
            // Calculate years from past 10 years (as far back as CRA allows)
            for (let year = currentYear - 10; year < currentYear; year++) {
                const ageAtYear = state.currentAge - (currentYear - year);
                
                years.push({
                    year,
                    age: ageAtYear,
                    grantEligible: ageAtYear >= state.dtcStartAge && ageAtYear <= 49,
                    bondEligible: ageAtYear >= state.dtcStartAge && ageAtYear <= 49,
                    income: 0 // User can input their own income
                });
            }
            
            return years;
        }

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-CA', {
                style: 'currency',
                currency: 'CAD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(value);
        }

        // Calculate annual grant
        function calculateAnnualGrant(income, contribution, age) {
            if (age > 49) return 0;
            
            let grant = 0;
            
            if (income <= 114750) {
                const first500 = Math.min(contribution, 500);
                grant += first500 * 3;
                
                if (contribution > 500) {
                    const next1000 = Math.min(contribution - 500, 1000);
                    grant += next1000 * 2;
                }
                return Math.min(grant, 3500);
            } else {
                return Math.min(contribution, 1000);
            }
        }

        // Calculate annual bond
        function calculateAnnualBond(income, age) {
            if (age > 49) return 0;
            
            if (income <= 37487) {
                return 1000;
            } else if (income < 57375) {
                const ratio = (57375 - income) / (57375 - 37487);
                return Math.round(1000 * ratio);
            }
            return 0;
        }

        // Calculate carry-forward
        function calculateCarryForward() {
            let availableGrants = [];
            let availableBonds = [];
            
            state.carryForwardYears.forEach(yearData => {
                if (yearData.grantEligible && yearData.age <= 49 && yearData.age >= state.dtcStartAge) {
                    const maxGrant = (yearData.income || 0) <= 114750 ? 3500 : 1000;
                    availableGrants.push({ year: yearData.year, amount: maxGrant, age: yearData.age });
                }
                if (yearData.bondEligible && yearData.age <= 49 && yearData.age >= state.dtcStartAge) {
                    const bond = calculateAnnualBond(yearData.income || 0, yearData.age);
                    if (bond > 0) {
                        availableBonds.push({ year: yearData.year, amount: bond, age: yearData.age });
                    }
                }
            });
            
            return { grants: availableGrants, bonds: availableBonds };
        }

        // Calculate LDAP
        function calculateLDAP(balance, age, govtContribs, personalContribs) {
            if (age < 60) return 0;
            
            if (govtContribs > personalContribs) {
                if (age < 80) {
                    const yearsUntil83 = 83 - age;
                    return balance / yearsUntil83;
                } else {
                    return balance / 3;
                }
            } else {
                const minimum = age < 80 ? balance / (83 - age) : balance / 3;
                const tenPercent = balance * 0.1;
                return Math.max(minimum, tenPercent);
            }
        }

        // Calculate projections
        function calculateProjections() {
            const data = [];
            let accountBalance = 0;
            let totalContributions = 0;
            let totalGrants = 0;
            let totalBonds = 0;
            let totalWithdrawals = 0;
            let totalTaxableWithdrawals = 0;
            let lifetimeGrantTotal = 0;
            let lifetimeBondTotal = 0;
            let grantsInLast10Years = [];
            
            const carryForward = calculateCarryForward();
            let remainingCarryForwardGrants = [...carryForward.grants];
            let remainingCarryForwardBonds = [...carryForward.bonds];
            
            const maxAge = state.endAge || 90;
            
            for (let age = state.currentAge; age <= maxAge; age++) {
                const year = age - state.currentAge;
                let yearlyContribution = 0;
                let yearlyGrant = 0;
                let yearlyBond = 0;
                let yearlyWithdrawal = 0;
                let yearlyGrowth = 0;
                let yearlyDividend = 0;
                let repaymentPenalty = 0;
                let taxableWithdrawal = 0;
                
                const currentDate = new Date().getFullYear() + (age - state.currentAge);
                grantsInLast10Years = grantsInLast10Years.filter(g => currentDate - g.year < 10);
                
                // If user is doing manual withdrawals, optionally stop contributions starting at the earliest withdrawal age.
                const earliestWithdrawalAge = state.withdrawals.length > 0
                    ? Math.min(...state.withdrawals.map(w => w.age))
                    : Infinity;
                const shouldStopContribs = state.stopContribsAtWithdrawal &&
                                         state.withdrawalType === 'manual' &&
                                         age >= earliestWithdrawalAge;
                
                if (age <= 59 && totalContributions < 200000 && !shouldStopContribs) {
                    yearlyContribution = Math.min(state.annualContribution, 200000 - totalContributions);
                    totalContributions += yearlyContribution;
                    accountBalance += yearlyContribution;
                }
                
                if (age <= 49 && lifetimeGrantTotal < 70000) {
                    let grantsThisYear = 0;
                    const currentYearGrant = yearlyContribution > 0 ? calculateAnnualGrant(state.familyIncome, yearlyContribution, age) : 0;
                    
                    while (remainingCarryForwardGrants.length > 0 && grantsThisYear < 10500 && lifetimeGrantTotal < 70000) {
                        const carryForwardGrant = remainingCarryForwardGrants[0];
                        const spaceInYear = Math.min(10500 - grantsThisYear, 70000 - lifetimeGrantTotal);
                        const grantToAdd = Math.min(carryForwardGrant.amount, spaceInYear);
                        
                        grantsThisYear += grantToAdd;
                        lifetimeGrantTotal += grantToAdd;
                        grantsInLast10Years.push({ amount: grantToAdd, year: currentDate, type: 'grant' });
                        
                        if (grantToAdd >= carryForwardGrant.amount) {
                            remainingCarryForwardGrants.shift();
                        } else {
                            carryForwardGrant.amount -= grantToAdd;
                            break;
                        }
                    }
                    
                    if (grantsThisYear + currentYearGrant <= 10500 && lifetimeGrantTotal + currentYearGrant <= 70000) {
                        grantsThisYear += currentYearGrant;
                        lifetimeGrantTotal += currentYearGrant;
                        grantsInLast10Years.push({ amount: currentYearGrant, year: currentDate, type: 'grant' });
                    }
                    
                    yearlyGrant = grantsThisYear;
                    totalGrants += yearlyGrant;
                    accountBalance += yearlyGrant;
                }
                
                if (age <= 49 && lifetimeBondTotal < 20000) {
                    let bondsThisYear = 0;
                    const currentYearBond = calculateAnnualBond(state.familyIncome, age);
                    
                    while (remainingCarryForwardBonds.length > 0 && bondsThisYear < 11000 && lifetimeBondTotal < 20000) {
                        const carryForwardBond = remainingCarryForwardBonds[0];
                        const spaceInYear = Math.min(11000 - bondsThisYear, 20000 - lifetimeBondTotal);
                        const bondToAdd = Math.min(carryForwardBond.amount, spaceInYear);
                        
                        bondsThisYear += bondToAdd;
                        lifetimeBondTotal += bondToAdd;
                        grantsInLast10Years.push({ amount: bondToAdd, year: currentDate, type: 'bond' });
                        
                        if (bondToAdd >= carryForwardBond.amount) {
                            remainingCarryForwardBonds.shift();
                        } else {
                            carryForwardBond.amount -= bondToAdd;
                            break;
                        }
                    }
                    
                    if (bondsThisYear + currentYearBond <= 11000 && lifetimeBondTotal + currentYearBond <= 20000) {
                        bondsThisYear += currentYearBond;
                        lifetimeBondTotal += currentYearBond;
                        grantsInLast10Years.push({ amount: currentYearBond, year: currentDate, type: 'bond' });
                    }
                    
                    yearlyBond = bondsThisYear;
                    totalBonds += yearlyBond;
                    accountBalance += yearlyBond;
                }
                
                if (accountBalance > 0) {
                    const growthRate = state.payDividends ? (state.returnRate - state.dividendRate) / 100 : state.returnRate / 100;
                    yearlyGrowth = accountBalance * growthRate;
                    accountBalance += yearlyGrowth;
                    
                    if (state.payDividends) {
                        yearlyDividend = accountBalance * (state.dividendRate / 100);
                    }
                }
                
                const assistanceHoldback = grantsInLast10Years.reduce((sum, g) => sum + g.amount, 0);
                const govtContributions = totalGrants + totalBonds;
                
                if (state.withdrawalType === 'ldap' && age >= state.ldapStartAge) {
                    const ldapAmount = calculateLDAP(accountBalance, age, govtContributions, totalContributions);
                    yearlyWithdrawal = Math.min(ldapAmount, accountBalance);
                    
                    const personalContribPortion = Math.min(yearlyWithdrawal, totalContributions / (totalContributions + govtContributions + yearlyGrowth) * yearlyWithdrawal);
                    taxableWithdrawal = yearlyWithdrawal - personalContribPortion;
                    
                } else if (state.withdrawalType === 'manual') {
                    const withdrawal = state.withdrawals.find(w => w.age === age);
                    if (withdrawal) {
                        yearlyWithdrawal = Math.min(withdrawal.amount, accountBalance);
                        
                        if (age < 60 && assistanceHoldback > 0) {
                            const maxRepayment = Math.min(assistanceHoldback, yearlyWithdrawal * 3);
                            repaymentPenalty = maxRepayment;
                            
                            accountBalance -= repaymentPenalty;
                            
                            let remainingPenalty = repaymentPenalty;
                            grantsInLast10Years = grantsInLast10Years.filter(g => {
                                if (remainingPenalty > 0) {
                                    const toRemove = Math.min(g.amount, remainingPenalty);
                                    remainingPenalty -= toRemove;
                                    g.amount -= toRemove;
                                    return g.amount > 0;
                                }
                                return true;
                            });
                        }
                        
                        const personalContribPortion = Math.min(yearlyWithdrawal, totalContributions / (totalContributions + govtContributions) * yearlyWithdrawal);
                        taxableWithdrawal = yearlyWithdrawal - personalContribPortion;
                    }
                }
                
                accountBalance -= yearlyWithdrawal;
                totalWithdrawals += yearlyWithdrawal;
                totalTaxableWithdrawals += taxableWithdrawal;
                
                data.push({
                    age,
                    year: year + 1,
                    contribution: Math.round(yearlyContribution),
                    grant: Math.round(yearlyGrant),
                    bond: Math.round(yearlyBond),
                    withdrawal: Math.round(yearlyWithdrawal),
                    taxableWithdrawal: Math.round(taxableWithdrawal),
                    repaymentPenalty: Math.round(repaymentPenalty),
                    growth: Math.round(yearlyGrowth),
                    dividend: Math.round(yearlyDividend),
                    balance: Math.round(Math.max(0, accountBalance)),
                    totalContributions: Math.round(totalContributions),
                    totalGrants: Math.round(totalGrants),
                    totalBonds: Math.round(totalBonds),
                    assistanceHoldback: Math.round(assistanceHoldback),
                    govtContributions: Math.round(govtContributions),
                });
            }
            
            return {
                data,
                summary: {
                    finalBalance: Math.round(Math.max(0, accountBalance)),
                    totalContributions: Math.round(totalContributions),
                    totalGrants: Math.round(totalGrants),
                    totalBonds: Math.round(totalBonds),
                    totalGovernment: Math.round(totalGrants + totalBonds),
                    totalWithdrawals: Math.round(totalWithdrawals),
                    totalTaxableWithdrawals: Math.round(totalTaxableWithdrawals),
                }
            };
        }

        // Update UI
        function updateCalculations() {
            // Update state from inputs
            state.currentAge = parseInt(document.getElementById('currentAge').value) || 30;
            state.familyIncome = parseInt(document.getElementById('familyIncome').value) || 100000;
            state.annualContribution = parseInt(document.getElementById('annualContribution').value) || 1500;
            state.returnRate = parseFloat(document.getElementById('returnRate').value) || 5;
            state.payDividends = document.getElementById('payDividends').checked;
            state.dividendRate = parseFloat(document.getElementById('dividendRate').value) || 2;
            state.dtcStartAge = parseInt(document.getElementById('dtcStartAge').value) || 17;
            state.endAge = parseInt(document.getElementById('endAge').value) || 90;
            state.comparisonStartAge = parseInt(document.getElementById('comparisonStartAge')?.value) || 60;
            state.withdrawalType = document.querySelector('input[name="withdrawalType"]:checked').value;
            state.stopContribsAtWithdrawal = document.getElementById('stopContribsAtWithdrawal')?.checked ?? true;
            state.showComparison = document.getElementById('showComparison')?.checked ?? false;
            // Manual quick plan (optional inputs only shown in manual mode)
            state.manualStartAge = parseInt(document.getElementById('manualStartAge')?.value) || state.manualStartAge || 60;
            state.manualEndAge = parseInt(document.getElementById('manualEndAge')?.value) || state.manualEndAge || state.endAge || 90;
            state.manualAnnualWithdrawal = parseFloat(document.getElementById('manualAnnualWithdrawal')?.value) || state.manualAnnualWithdrawal || 0;
            
            // Update carry-forward years ages
            const currentYear = new Date().getFullYear();
            state.carryForwardYears.forEach(yearData => {
                yearData.age = state.currentAge - (currentYear - yearData.year);
                yearData.grantEligible = yearData.age >= state.dtcStartAge && yearData.age <= 49;
                yearData.bondEligible = yearData.age >= state.dtcStartAge && yearData.age <= 49;
            });
            
            // Update UI visibility
            document.getElementById('dividendRateContainer').style.display = state.payDividends ? 'block' : 'none';
            document.getElementById('stopContribsContainer').style.display = state.withdrawalType === 'manual' ? 'block' : 'none';
            document.getElementById('manualWithdrawalSection').style.display = state.withdrawalType === 'manual' ? 'block' : 'none';
            document.getElementById('ldapAgeContainer').style.display = state.withdrawalType === 'ldap' ? 'block' : 'none';
            // Only show the comparison UI for LDAP mode (it compares LDAP vs "optimal", not manual DAPs)
            const comparisonToggleContainer = document.getElementById('comparisonToggleContainer');
            if (comparisonToggleContainer) {
                comparisonToggleContainer.style.display = state.withdrawalType === 'ldap' ? 'block' : 'none';
            }
            document.getElementById('comparisonAgeContainer').style.display = (state.withdrawalType === 'ldap' && state.showComparison) ? 'block' : 'none';
            
            if (state.withdrawalType === 'ldap') {
                state.ldapStartAge = parseInt(document.getElementById('ldapAge').value) || 60;
            } else {
                // In manual mode, comparison isn't relevant; keep it off to avoid confusion
                state.showComparison = false;
            }
            
            // Update income eligibility
            const income = state.familyIncome;
            let eligibilityText = '';
            if (income <= 37487) {
                eligibilityText = '✓ Eligible for maximum bond ($1,000/yr)';
            } else if (income < 57375) {
                eligibilityText = '✓ Eligible for partial bond';
            } else if (income <= 114750) {
                eligibilityText = '✓ No bond, 3:1 & 2:1 grant matching';
            } else {
                eligibilityText = '✓ 1:1 grant matching only';
            }
            document.getElementById('incomeEligibility').textContent = eligibilityText;
            
            // Calculate projections
            const projections = calculateProjections();
            allProjectionData = projections.data; // Store all data

            // Precompute a "no growth" version for hover display when Growth is toggled off
            // (This avoids confusing users with balances that include hidden growth.)
            const savedReturnRate = state.returnRate;
            const savedPayDividends = state.payDividends;
            const savedDividendRate = state.dividendRate;
            state.returnRate = 0;
            state.payDividends = false;
            state.dividendRate = 0;
            try {
                noGrowthProjectionData = calculateProjections().data;
            } finally {
                state.returnRate = savedReturnRate;
                state.payDividends = savedPayDividends;
                state.dividendRate = savedDividendRate;
            }
            
            // Update summary cards
            updateSummaryCards(projections.summary);
            
            // Update carry-forward display
            updateCarryForwardDisplay();
            
            // Update withdrawals display
            updateWithdrawalsDisplay();
            
            // Update chart age range sliders
            updateChartAgeRangeSliders();
            
            // Update visual slider
            updateVisualSlider();
            
            // Update charts with filtered data
            updateCharts();
        }

        function updateSummaryCards(summary) {
            const cards = [
                { label: 'Final Balance', value: summary.finalBalance },
                { label: 'Your Contributions', value: summary.totalContributions },
                { label: 'Total Grants', value: summary.totalGrants },
                { label: 'Total Bonds', value: summary.totalBonds },
                { label: 'Govt. Total', value: summary.totalGovernment },
                { label: 'Taxable Withdrawals', value: summary.totalTaxableWithdrawals },
            ];
            
            const container = document.getElementById('summaryCards');
            container.innerHTML = cards.map(card => `
                <div class="summary-card">
                    <div class="label">${card.label}</div>
                    <div class="value">${formatCurrency(card.value)}</div>
                </div>
            `).join('');
        }

        function updateCarryForwardDisplay() {
            const cf = calculateCarryForward();
            const totalGrants = cf.grants.reduce((sum, g) => sum + g.amount, 0);
            const totalBonds = cf.bonds.reduce((sum, b) => sum + b.amount, 0);
            
            const summaryEl = document.getElementById('carryForwardSummary');
            summaryEl.innerHTML = 
                `Available: <span class="clickable-amount text-indigo-600 hover:text-indigo-700 cursor-pointer underline font-semibold" onclick="showGrantPreview(${cf.grants.length})">${formatCurrency(totalGrants)} in grants (${cf.grants.length} years)</span> + <span class="clickable-amount text-indigo-600 hover:text-indigo-700 cursor-pointer underline font-semibold" onclick="showBondPreview(${cf.bonds.length})">${formatCurrency(totalBonds)} in bonds (${cf.bonds.length} years)</span>`;
            
            const container = document.getElementById('carryForwardYears');
            container.innerHTML = state.carryForwardYears.map((yearData, index) => `
                <div class="bg-white p-3 rounded-lg border border-gray-200">
                    <div class="grid grid-cols-6 gap-3 items-center">
                        <div>
                            <div class="text-xs text-gray-600">Year</div>
                            <div class="font-semibold">${yearData.year}</div>
                            <div class="text-xs text-gray-500">Age ${yearData.age}</div>
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-gray-600">Income that year</label>
                            <input type="number" value="${yearData.income}" 
                                oninput="updateCarryForwardYear(${index}, 'income', this.value)"
                                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-transparent" min="0">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" ${yearData.grantEligible ? 'checked' : ''} 
                                onchange="updateCarryForwardYear(${index}, 'grantEligible', this.checked)"
                                ${yearData.age > 49 || yearData.age < state.dtcStartAge ? 'disabled' : ''}
                                class="h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded disabled:opacity-50">
                            <label class="ml-2 text-sm text-gray-700">Grant</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" ${yearData.bondEligible ? 'checked' : ''} 
                                onchange="updateCarryForwardYear(${index}, 'bondEligible', this.checked)"
                                ${yearData.age > 49 || yearData.age < state.dtcStartAge ? 'disabled' : ''}
                                class="h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded disabled:opacity-50">
                            <label class="ml-2 text-sm text-gray-700">Bond</label>
                        </div>
                        <div class="text-xs text-gray-600 grant-bond-display">
                            ${yearData.grantEligible && yearData.age <= 49 ? `
                                <div class="text-gray-800">
                                    Grant: ${formatCurrency((yearData.income || 0) <= 114750 ? 3500 : 1000)}
                                </div>
                            ` : ''}
                            ${yearData.bondEligible && yearData.age <= 49 ? `
                                <div class="text-gray-800">
                                    Bond: ${formatCurrency(calculateAnnualBond(yearData.income || 0, yearData.age))}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show grant preview breakdown
        function showGrantPreview(yearsCount) {
            const eligibleYears = state.carryForwardYears.filter(y => y.grantEligible && y.age <= 49 && y.age >= state.dtcStartAge);
            
            // Calculate grants at different income levels
            let lowIncomeTotal = 0;
            let highIncomeTotal = 0;
            
            eligibleYears.forEach(yearData => {
                // Low income: $3,500 max per year (if contributing $1,500)
                const lowGrant = Math.min(3500, 1500 * 3 + Math.max(0, 1500 - 500) * 2);
                lowIncomeTotal += Math.min(lowGrant, 3500);
                
                // High income: $1,000 max per year (1:1 matching)
                highIncomeTotal += Math.min(1000, 1500);
            });
            
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewModalTitle');
            const content = document.getElementById('previewModalContent');
            
            title.textContent = `Grant Preview (${yearsCount} eligible years)`;
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                        <div class="font-semibold text-green-800 mb-2">At Low Income (≤$114,750)</div>
                        <div class="text-sm text-green-700 space-y-1">
                            <div>• Max per year: <strong>${formatCurrency(3500)}</strong></div>
                            <div>• Total potential: <strong>${formatCurrency(Math.min(lowIncomeTotal, 3500 * yearsCount))}</strong></div>
                            <div class="text-xs mt-2">Based on $1,500 contribution: $500×3 + $1,000×2 = $3,500</div>
                        </div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="font-semibold text-blue-800 mb-2">At High Income (>$114,750)</div>
                        <div class="text-sm text-blue-700 space-y-1">
                            <div>• Max per year: <strong>${formatCurrency(1000)}</strong></div>
                            <div>• Total potential: <strong>${formatCurrency(Math.min(highIncomeTotal, 1000 * yearsCount))}</strong></div>
                            <div class="text-xs mt-2">Based on 1:1 matching</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 pt-2 border-t border-gray-200">
                        <strong>Note:</strong> Lifetime grant limit is ${formatCurrency(70000)}. Enter income for each year to see exact amounts.
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }
        
        // Show bond preview breakdown
        function showBondPreview(yearsCount) {
            const eligibleYears = state.carryForwardYears.filter(y => y.bondEligible && y.age <= 49 && y.age >= state.dtcStartAge);
            
            // Calculate bonds at different income levels
            let veryLowTotal = 0;
            let midTotal = 0;
            
            eligibleYears.forEach(yearData => {
                // Very low income: Full $1,000 bond
                veryLowTotal += 1000;
                
                // Mid income: Partial bond (proportional)
                const midBond = calculateAnnualBond(50000, yearData.age);
                midTotal += midBond;
            });
            
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewModalTitle');
            const content = document.getElementById('previewModalContent');
            
            title.textContent = `Bond Preview (${yearsCount} eligible years)`;
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                        <div class="font-semibold text-green-800 mb-2">At Very Low Income (≤$37,487)</div>
                        <div class="text-sm text-green-700 space-y-1">
                            <div>• Bond per year: <strong>${formatCurrency(1000)}</strong></div>
                            <div>• Total potential: <strong>${formatCurrency(veryLowTotal)}</strong></div>
                        </div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div class="font-semibold text-yellow-800 mb-2">At Mid Income ($37,487-$57,375)</div>
                        <div class="text-sm text-yellow-700 space-y-1">
                            <div>• Bond per year: Varies (proportional)</div>
                            <div>• Example at $50,000: <strong>${formatCurrency(calculateAnnualBond(50000, 30))}/year</strong></div>
                            <div>• Total potential: <strong>~${formatCurrency(midTotal)}</strong></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <div class="font-semibold text-gray-800 mb-2">At High Income (>$57,375)</div>
                        <div class="text-sm text-gray-700">
                            <div>• Bond per year: <strong>$0</strong></div>
                            <div>• Total potential: <strong>$0</strong></div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 pt-2 border-t border-gray-200">
                        <strong>Note:</strong> Lifetime bond limit is ${formatCurrency(20000)}. Enter income for each year to see exact amounts.
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }
        
        // Close preview modal
        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
        
        // Debounce timer for carry-forward calculations
        let carryForwardDebounceTimer = null;
        
        function updateCarryForwardYear(index, field, value) {
            if (field === 'income') {
                // For income, use the value parameter (from this.value in oninput)
                // This preserves what the user is actually typing
                const incomeValue = value === '' ? 0 : (parseInt(value) || 0);
                
                // Update state for calculations
                state.carryForwardYears[index][field] = incomeValue;
                
                // Update only the grant/bond display for this specific row without recreating inputs
                updateCarryForwardRowDisplay(index, incomeValue);
                
                // Update summary
                const cf = calculateCarryForward();
                const totalGrants = cf.grants.reduce((sum, g) => sum + g.amount, 0);
                const totalBonds = cf.bonds.reduce((sum, b) => sum + b.amount, 0);
                document.getElementById('carryForwardSummary').textContent = 
                    `Available: ${formatCurrency(totalGrants)} in grants (${cf.grants.length} years) + ${formatCurrency(totalBonds)} in bonds (${cf.bonds.length} years)`;
                
                // Debounce full calculations (wait 500ms after user stops typing)
                clearTimeout(carryForwardDebounceTimer);
                carryForwardDebounceTimer = setTimeout(() => {
                    updateCalculations();
                }, 500);
            } else {
                // For checkboxes, update state and do full update
                state.carryForwardYears[index][field] = value;
                updateCarryForwardDisplay();
                updateCalculations();
            }
        }
        
        // Update only a specific row's grant/bond display without recreating the input
        function updateCarryForwardRowDisplay(index, incomeValue) {
            const container = document.getElementById('carryForwardYears');
            const rows = container.children;
            if (rows[index]) {
                const yearData = state.carryForwardYears[index];
                const grantBondDiv = rows[index].querySelector('.grant-bond-display');
                if (grantBondDiv) {
                    // Use the passed incomeValue or fall back to state
                    const income = incomeValue !== undefined ? incomeValue : (yearData.income || 0);
                    grantBondDiv.innerHTML = `
                        ${yearData.grantEligible && yearData.age <= 49 ? `
                            <div class="text-gray-800">
                                Grant: ${formatCurrency(income <= 114750 ? 3500 : 1000)}
                            </div>
                        ` : ''}
                        ${yearData.bondEligible && yearData.age <= 49 ? `
                            <div class="text-gray-800">
                                Bond: ${formatCurrency(calculateAnnualBond(income, yearData.age))}
                            </div>
                        ` : ''}
                    `;
                }
            }
        }

        function updateWithdrawalsDisplay() {
            const container = document.getElementById('withdrawalsList');
            if (state.withdrawals.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm font-semibold text-gray-800">
                                ${state.withdrawals.length} withdrawal${state.withdrawals.length !== 1 ? 's' : ''} scheduled
                            </div>
                            ${state.withdrawals.some(w => w.age < 60) ? `
                                <div class="text-xs text-gray-700 mt-1">
                                    ${state.withdrawals.filter(w => w.age < 60).length} early withdrawal${state.withdrawals.filter(w => w.age < 60).length !== 1 ? 's' : ''} (before 60) - penalties will apply
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="clearWithdrawals()" class="px-3 py-1 bg-gray-700 text-white text-sm rounded-md hover:bg-gray-800">
                            Clear All
                        </button>
                    </div>
                </div>
                ${state.withdrawals.map((withdrawal, index) => `
                    <div class="flex gap-3 items-center bg-gray-50 p-3 rounded-lg mb-2">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-600 mb-1">Age</label>
                            <input type="number" value="${withdrawal.age}" 
                                oninput="updateWithdrawal(${index}, 'age', this.value)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-gray-500 focus:border-transparent" 
                                min="${state.currentAge}">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs text-gray-600 mb-1">Amount</label>
                            <input type="number" value="${withdrawal.amount}" 
                                oninput="updateWithdrawal(${index}, 'amount', this.value)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-gray-500 focus:border-transparent" 
                                min="0">
                        </div>
                        <button onclick="removeWithdrawal(${index})" class="mt-5 px-3 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-800">
                            Remove
                        </button>
                    </div>
                `).join('')}
            `;
        }

        function addWithdrawal() {
            state.withdrawals.push({ age: state.currentAge + 5, amount: 5000 });
            updateWithdrawalsDisplay();
            updateCalculations();
        }

        function syncManualQuickPlan() {
            // Light sync helper so typing feels responsive; full recalculation happens via updateCalculations().
            const startEl = document.getElementById('manualStartAge');
            const endEl = document.getElementById('manualEndAge');
            if (!startEl || !endEl) return;
            const start = parseInt(startEl.value) || state.currentAge || 30;
            const end = parseInt(endEl.value) || state.endAge || 90;
            if (end < start) endEl.value = String(start);
        }

        function generateWithdrawalSchedule() {
            const startEl = document.getElementById('manualStartAge');
            const endEl = document.getElementById('manualEndAge');
            const amountEl = document.getElementById('manualAnnualWithdrawal');
            if (!startEl || !endEl || !amountEl) return;
            
            const startAge = parseInt(startEl.value) || state.currentAge || 30;
            const endAge = parseInt(endEl.value) || state.endAge || 90;
            const amount = parseFloat(amountEl.value) || 0;
            
            const minAge = state.currentAge || 30;
            const maxAge = state.endAge || 90;
            const s = Math.max(minAge, Math.min(maxAge, startAge));
            const e = Math.max(s, Math.min(maxAge, endAge));
            
            const withdrawals = [];
            for (let age = s; age <= e; age++) {
                withdrawals.push({ age, amount });
            }
            
            state.withdrawals = withdrawals;
            updateWithdrawalsDisplay();
            updateCalculations();
        }

        function removeWithdrawal(index) {
            state.withdrawals.splice(index, 1);
            updateWithdrawalsDisplay();
            updateCalculations();
        }

        function updateWithdrawal(index, field, value) {
            if (field === 'age') {
                state.withdrawals[index][field] = value === '' ? state.currentAge : (parseInt(value) || state.currentAge);
            } else {
                state.withdrawals[index][field] = value === '' ? 0 : (parseFloat(value) || 0);
            }
            updateCalculations();
        }

        function clearWithdrawals() {
            state.withdrawals = [];
            updateWithdrawalsDisplay();
            updateCalculations();
        }

        let balanceChart = null;
        let breakdownChart = null;
        let withdrawalChart = null;

        // Visual range slider drag functionality
        let isDragging = false;
        let dragHandle = null;
        
        function startDrag(handle, event) {
            event.preventDefault();
            isDragging = true;
            dragHandle = handle;
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', onDrag);
            document.addEventListener('touchend', stopDrag);
        }
        
        function onDrag(event) {
            if (!isDragging) return;
            
            const track = document.getElementById('rangeTrack');
            if (!track) return;
            const rect = track.getBoundingClientRect();
            const clientX = event.clientX || (event.touches && event.touches[0].clientX);
            const percent = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
            
            const maxAge = state.endAge || 90;
            const minAge = state.currentAge || 30;
            const ageRange = maxAge - minAge;
            const age = Math.round(minAge + (percent / 100) * ageRange);
            
            if (dragHandle === 'left') {
                state.chartAgeRange[0] = Math.min(age, state.chartAgeRange[1] - 1);
            } else {
                state.chartAgeRange[1] = Math.max(age, state.chartAgeRange[0] + 1);
            }
            
            updateVisualSlider();
            updateCharts();
        }
        
        function stopDrag() {
            isDragging = false;
            dragHandle = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('touchend', stopDrag);
        }
        
        function updateVisualSlider() {
            const maxAge = state.endAge || 90;
            const minAge = state.currentAge || 30;
            const ageRange = maxAge - minAge;
            if (ageRange <= 0) return;
            
            const leftPercent = ((state.chartAgeRange[0] - minAge) / ageRange) * 100;
            const rightPercent = ((state.chartAgeRange[1] - minAge) / ageRange) * 100;
            const widthPercent = rightPercent - leftPercent;
            
            const leftHandle = document.getElementById('leftHandle');
            const rightHandle = document.getElementById('rightHandle');
            const rangeHighlight = document.getElementById('rangeHighlight');
            
            if (leftHandle) leftHandle.style.left = leftPercent + '%';
            if (rightHandle) rightHandle.style.left = rightPercent + '%';
            if (rangeHighlight) {
                rangeHighlight.style.left = leftPercent + '%';
                rangeHighlight.style.width = widthPercent + '%';
            }
            
            document.getElementById('ageRangeDisplay').textContent = `${state.chartAgeRange[0]} - ${state.chartAgeRange[1]}`;
            document.getElementById('minAgeLabel').textContent = state.chartAgeRange[0];
            document.getElementById('maxAgeLabel').textContent = state.chartAgeRange[1];
        }
        
        function updateChartAgeRange() {
            // This function is kept for compatibility but now uses visual slider
            updateVisualSlider();
            updateCharts();
        }
        
        function updateChartAgeRangeFromInput(type, value) {
            const numValue = parseInt(value) || 0;
            const maxAge = state.endAge || 90;
            const minAge = state.currentAge || 30;
            
            // Clamp values to valid range
            const clampedValue = Math.max(minAge, Math.min(maxAge, numValue));
            
            if (type === 'min') {
                state.chartAgeRange[0] = Math.min(clampedValue, state.chartAgeRange[1] - 1);
            } else {
                state.chartAgeRange[1] = Math.max(clampedValue, state.chartAgeRange[0] + 1);
            }
            
            updateVisualSlider();
            updateCharts();
        }

        function updateChartAgeRangeSliders() {
            // Set range based on currentAge and endAge
            const maxAge = state.endAge || 90;
            const minAge = state.currentAge || 30;
            
            // Ensure current range is within bounds
            if (state.chartAgeRange[0] > maxAge) state.chartAgeRange[0] = minAge;
            if (state.chartAgeRange[1] > maxAge) state.chartAgeRange[1] = maxAge;
            if (state.chartAgeRange[0] < minAge) state.chartAgeRange[0] = minAge;
            if (state.chartAgeRange[1] < minAge) state.chartAgeRange[1] = minAge;
            
            // Ensure min <= max
            if (state.chartAgeRange[0] > state.chartAgeRange[1]) {
                state.chartAgeRange[0] = minAge;
                state.chartAgeRange[1] = maxAge;
            }
            
            // Update visual slider
            updateVisualSlider();
        }

        function setChartRange(range) {
            const maxAge = state.endAge || 90;
            const minAge = state.currentAge || 30;
            switch(range) {
                case 'early':
                    state.chartAgeRange = [minAge, Math.min(minAge + 20, maxAge)];
                    break;
                case 'mid':
                    state.chartAgeRange = [Math.max(minAge, 50), Math.min(70, maxAge)];
                    break;
                case 'late':
                    state.chartAgeRange = [Math.max(minAge, 70), maxAge];
                    break;
                case 'all':
                    state.chartAgeRange = [minAge, maxAge];
                    break;
            }
            updateVisualSlider();
            updateCharts();
        }

        function getFilteredChartData() {
            if (!allProjectionData || allProjectionData.length === 0) return [];
            return allProjectionData.filter(d => 
                d.age >= state.chartAgeRange[0] && d.age <= state.chartAgeRange[1]
            );
        }

        // Get chart colors based on dark mode
        function getChartColors() {
            const isDark = document.body.classList.contains('dark-mode');
            return {
                text: isDark ? '#d1d5db' : '#374151',
                grid: isDark ? '#374151' : '#e5e7eb',
                background: isDark ? '#1f2937' : '#ffffff'
            };
        }

        function updateCharts() {
            const data = getFilteredChartData();
            if (data.length === 0) return;
            const colors = getChartColors();
            
            // Balance Chart
            const balanceCtx = document.getElementById('balanceChart').getContext('2d');
            if (balanceChart) balanceChart.destroy();
            balanceChart = new Chart(balanceCtx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.age),
                    datasets: [{
                        label: 'Account Balance',
                        data: data.map(d => d.balance),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: colors.text }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#f8fafc',
                            bodyColor: '#f8fafc',
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: colors.text,
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            grid: {
                                color: colors.grid
                            }
                        },
                        x: {
                            ticks: {
                                color: colors.text
                            },
                            grid: {
                                color: colors.grid
                            }
                        }
                    }
                }
            });

            // Breakdown Chart
            const breakdownCtx = document.getElementById('breakdownChart').getContext('2d');
            if (breakdownChart) breakdownChart.destroy();
            breakdownChart = new Chart(breakdownCtx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.age),
                    datasets: [
                        { label: 'Contributions', data: data.map(d => d.contribution), borderColor: '#3b82f6', tension: 0.4 },
                        { label: 'Grants', data: data.map(d => d.grant), borderColor: '#8b5cf6', tension: 0.4 },
                        { label: 'Bonds', data: data.map(d => d.bond), borderColor: '#ec4899', tension: 0.4 },
                        { label: 'Growth', data: data.map(d => d.growth), borderColor: '#10b981', tension: 0.4 },
                        { label: 'Withdrawals', data: data.map(d => d.withdrawal), borderColor: '#ef4444', tension: 0.4 },
                        ...(state.withdrawalType === 'manual' ? [{
                            label: '10-Year Penalty',
                            data: data.map(d => d.repaymentPenalty),
                            borderColor: '#f97316',
                            borderDash: [5, 5],
                            tension: 0.4
                        }] : [])
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: colors.text }
                        },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: colors.text,
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            grid: {
                                color: colors.grid
                            }
                        },
                        x: {
                            ticks: {
                                color: colors.text
                            },
                            grid: {
                                color: colors.grid
                            }
                        }
                    }
                }
            });

            // Update the hover side panel (so hover doesn't cover the chart)
            breakdownChart.options.onHover = (evt, activeEls) => {
                const panel = document.getElementById('breakdownHoverPanel');
                if (!panel) return;

                if (!activeEls || activeEls.length === 0) {
                    panel.innerHTML = `<div class="title">Hover details</div><div class="muted">Move your mouse over the chart to see the full breakdown for that age.</div>`;
                    return;
                }

                const idx = activeEls[0].index;
                const dataPoint = data[idx];
                if (!dataPoint || dataPoint.age === undefined) return;
                
                const age = dataPoint.age;

                const growthDataset = breakdownChart.data.datasets.find(ds => ds.label === 'Growth');
                const isGrowthHidden = growthDataset ? !breakdownChart.isDatasetVisible(growthDataset) : false;

                // If growth is hidden, show a balance computed with 0% return so the "total" doesn't include growth.
                let displayBalance = dataPoint.balance;
                if (isGrowthHidden && Array.isArray(noGrowthProjectionData) && noGrowthProjectionData.length > 0) {
                    const ng = noGrowthProjectionData.find(d => d.age === age);
                    if (ng) displayBalance = ng.balance;
                }

                const rows = [];
                rows.push(`<div class="title">Age ${age}</div>`);
                rows.push(`<div class="row"><span class="k">Account balance</span><span class="v">${formatCurrency(displayBalance)}</span></div>`);

                if (dataPoint.contribution > 0) rows.push(`<div class="row"><span class="k">Contributions</span><span class="v">${formatCurrency(dataPoint.contribution)}</span></div>`);
                if (dataPoint.grant > 0) rows.push(`<div class="row"><span class="k">Grants</span><span class="v">${formatCurrency(dataPoint.grant)}</span></div>`);
                if (dataPoint.bond > 0) rows.push(`<div class="row"><span class="k">Bonds</span><span class="v">${formatCurrency(dataPoint.bond)}</span></div>`);
                // Only show growth if it's not hidden in the chart
                if (!isGrowthHidden && dataPoint.growth > 0) rows.push(`<div class="row"><span class="k">Growth</span><span class="v">${formatCurrency(dataPoint.growth)}</span></div>`);
                if (dataPoint.withdrawal > 0) rows.push(`<div class="row"><span class="k">Withdrawals</span><span class="v">${formatCurrency(dataPoint.withdrawal)}</span></div>`);
                if (dataPoint.repaymentPenalty > 0) rows.push(`<div class="row"><span class="k">10-year penalty</span><span class="v">${formatCurrency(dataPoint.repaymentPenalty)}</span></div>`);

                if (dataPoint.totalContributions > 0) rows.push(`<div class="row"><span class="k">Total contributions</span><span class="v">${formatCurrency(dataPoint.totalContributions)}</span></div>`);
                if (dataPoint.totalGrants > 0) rows.push(`<div class="row"><span class="k">Total grants</span><span class="v">${formatCurrency(dataPoint.totalGrants)}</span></div>`);
                if (dataPoint.totalBonds > 0) rows.push(`<div class="row"><span class="k">Total bonds</span><span class="v">${formatCurrency(dataPoint.totalBonds)}</span></div>`);
                if (dataPoint.govtContributions > 0) rows.push(`<div class="row"><span class="k">Total govt</span><span class="v">${formatCurrency(dataPoint.govtContributions)}</span></div>`);

                panel.innerHTML = rows.join('');
            };

            // Withdrawal Chart
            const withdrawalData = data.filter(d => d.withdrawal > 0);
            if (withdrawalData.length > 0) {
                document.getElementById('withdrawalChartContainer').style.display = 'block';
                const withdrawalCtx = document.getElementById('withdrawalChart').getContext('2d');
                if (withdrawalChart) withdrawalChart.destroy();
                withdrawalChart = new Chart(withdrawalCtx, {
                    type: 'bar',
                    data: {
                        labels: withdrawalData.map(d => d.age),
                        datasets: [
                            { label: 'Total Withdrawal', data: withdrawalData.map(d => d.withdrawal), backgroundColor: '#3b82f6' },
                            { label: 'Taxable Portion', data: withdrawalData.map(d => d.taxableWithdrawal), backgroundColor: '#ef4444' },
                            ...(state.withdrawalType === 'manual' ? [{
                                label: '10-Year Penalty',
                                data: withdrawalData.map(d => d.repaymentPenalty),
                                backgroundColor: '#f97316'
                            }] : [])
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                labels: { color: colors.text }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#f8fafc',
                                bodyColor: '#f8fafc',
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: colors.text,
                                    callback: function(value) {
                                        return '$' + (value / 1000).toFixed(0) + 'k';
                                    }
                                },
                                grid: {
                                    color: colors.grid
                                }
                            },
                            x: {
                                ticks: {
                                    color: colors.text
                                },
                                grid: {
                                    color: colors.grid
                                }
                            }
                        }
                    }
                });
            } else {
                document.getElementById('withdrawalChartContainer').style.display = 'none';
            }
            
            // Always keep the table in sync (we show chart + table together)
            updateBreakdownTable();
        }
        
        function updateBreakdownTable() {
            const data = getFilteredChartData();
            const tbody = document.getElementById('breakdownTableBody');
            tbody.innerHTML = '';
            
            const isDark = document.body.classList.contains('dark-mode');
            const rowClass = isDark ? 'hover:bg-gray-700' : 'hover:bg-gray-50';
            const textClass = isDark ? 'text-gray-300' : 'text-gray-800';
            const textSecondaryClass = isDark ? 'text-gray-400' : 'text-gray-700';
            const borderClass = isDark ? 'border-gray-600' : 'border-gray-300';
            
            data.forEach(d => {
                const row = document.createElement('tr');
                row.className = rowClass;
                
                row.innerHTML = `
                    <td class="border ${borderClass} px-3 py-2 ${textClass}">${d.age}</td>
                    <td class="border ${borderClass} px-3 py-2 text-right ${textClass} font-medium">${formatCurrency(d.balance)}</td>
                    <td class="border ${borderClass} px-3 py-2 text-right ${textSecondaryClass}">${formatCurrency(d.contribution)}</td>
                    <td class="border ${borderClass} px-3 py-2 text-right ${textSecondaryClass}">${formatCurrency(d.grant)}</td>
                    <td class="border ${borderClass} px-3 py-2 text-right ${textSecondaryClass}">${formatCurrency(d.bond)}</td>
                    <td class="border ${borderClass} px-3 py-2 text-right ${textSecondaryClass}">${formatCurrency(d.growth)}</td>
                    <td class="border ${borderClass} px-3 py-2 text-right ${textSecondaryClass}">${formatCurrency(d.withdrawal)}</td>
                    <td class="border ${borderClass} px-3 py-2 text-right ${textSecondaryClass}">${formatCurrency(d.repaymentPenalty)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function resetCalculator() {
            state.currentAge = 30;
            state.familyIncome = 100000;
            state.annualContribution = 1500;
            state.returnRate = 5;
            state.payDividends = false;
            state.dividendRate = 2;
            state.withdrawals = [];
            state.dtcStartAge = 17;
            state.endAge = 90;
            state.showOptimalWithdrawal = false;
            state.ldapStartAge = 60;
            state.comparisonStartAge = 60;
            state.withdrawalType = 'ldap';
            state.stopContribsAtWithdrawal = true;
            state.showComparison = false;
            state.manualStartAge = 60;
            state.manualEndAge = 90;
            state.manualAnnualWithdrawal = 5000;
            state.carryForwardYears = initializeCarryForwardYears();
            state.chartAgeRange = [30, 90];
            
            document.getElementById('currentAge').value = state.currentAge;
            document.getElementById('familyIncome').value = state.familyIncome;
            document.getElementById('annualContribution').value = state.annualContribution;
            document.getElementById('returnRate').value = state.returnRate;
            document.getElementById('payDividends').checked = state.payDividends;
            document.getElementById('dividendRate').value = state.dividendRate;
            document.getElementById('dtcStartAge').value = state.dtcStartAge;
            document.getElementById('endAge').value = state.endAge;
            const comparisonStartAgeEl = document.getElementById('comparisonStartAge');
            if (comparisonStartAgeEl) comparisonStartAgeEl.value = state.comparisonStartAge;
            document.getElementById('ldapAge').value = state.ldapStartAge;
            const manualStartAgeEl = document.getElementById('manualStartAge');
            const manualEndAgeEl = document.getElementById('manualEndAge');
            const manualAnnualWithdrawalEl = document.getElementById('manualAnnualWithdrawal');
            if (manualStartAgeEl) manualStartAgeEl.value = state.manualStartAge;
            if (manualEndAgeEl) manualEndAgeEl.value = state.manualEndAge;
            if (manualAnnualWithdrawalEl) manualAnnualWithdrawalEl.value = state.manualAnnualWithdrawal;
            document.querySelector('input[name="withdrawalType"][value="ldap"]').checked = true;
            document.getElementById('stopContribsAtWithdrawal').checked = state.stopContribsAtWithdrawal;
            document.getElementById('showComparison').checked = state.showComparison;
            
            updateCalculations();
        }

            // Close modal when clicking outside
            document.getElementById('previewModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePreviewModal();
                }
            });
            
            // Initialize visual slider
            updateVisualSlider();
            
            // Initialize
            state.carryForwardYears = initializeCarryForwardYears();
            updateCalculations();
    </script>
</body>
</html>

